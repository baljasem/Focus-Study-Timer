<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Focus Study Timer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#020617">

  <style>
    body {
      font-family: system-ui, sans-serif;
      background: #020617;
      color: #e5e7eb;
      margin: 0;
      padding: 20px;
      text-align: center;
    }
    button {
      margin: 6px;
      padding: 10px 14px;
      font-size: 16px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
    }
    .primary { background: #2563eb; color: white; }
    .danger { background: #dc2626; color: white; }
    .success { background: #16a34a; color: white; }
    .hidden { display: none; }
    .box {
      border: 2px solid #334155;
      padding: 12px;
      margin: 8px 0;
      border-radius: 8px;
    }
  </style>
</head>

<body>

<h1>Focus Study Timer</h1>
<div id="sessionInfo"></div>

<div id="boxes"></div>

<div>
  <button id="startBtn" class="primary">Start Session</button>
  <button id="pauseBtn" class="primary hidden">Pause</button>
  <button id="resumeBtn" class="primary hidden">Resume</button>
  <button id="addBoxBtn">Add Extra Box</button>
</div>

<div>
  <button id="cancelBtn" class="danger hidden">Cancel Session</button>
  <button id="repeatBtn" class="success hidden">Repeat Session</button>
</div>

<div>
  <button id="historyToggle">Previous Sessions</button>
</div>

<div id="history" class="hidden"></div>

<script>
/* ---------------- STATE ---------------- */
let boxes = JSON.parse(localStorage.getItem("boxes")) || [25, 5];
let currentIndex = 0;
let remaining = 0;
let interval = null;
let paused = false;
let sessionStart = null;

/* ---------------- INIT ---------------- */
renderBoxes();
renderSessionInfo();

/* ---------------- UI ---------------- */
function renderBoxes() {
  const c = document.getElementById("boxes");
  c.innerHTML = "";
  boxes.forEach((m, i) => {
    const d = document.createElement("div");
    d.className = "box";
    d.id = "box-" + i;
    d.textContent = `Box ${i+1}: ${m} min`;
    c.appendChild(d);
  });
}

function renderSessionInfo() {
  const total = boxes.reduce((a,b)=>a+b,0);
  document.getElementById("sessionInfo").textContent =
    `Total session: ${total} minutes`;
}

/* ---------------- TIMER ---------------- */
function startSession() {
  sessionStart = Date.now();
  currentIndex = 0;
  startBox();
  toggleControls(true);
}

function startBox() {
  if (currentIndex >= boxes.length) {
    finishSession();
    return;
  }
  remaining = boxes[currentIndex] * 60;
  updateBoxUI();
  tick();
}

function tick() {
  interval = setInterval(() => {
    if (paused) return;
    remaining--;
    updateBoxUI();
    if (remaining <= 0) {
      bell();
      clearInterval(interval);
      currentIndex++;
      startBox();
    }
  }, 1000);
}

function updateBoxUI() {
  boxes.forEach((_, i) => {
    const el = document.getElementById("box-" + i);
    if (!el) return;
    if (i === currentIndex) {
      el.textContent =
        `Box ${i+1}: ${format(remaining)}`;
    }
  });
}

function pauseSession() {
  paused = true;
  document.getElementById("pauseBtn").classList.add("hidden");
  document.getElementById("resumeBtn").classList.remove("hidden");
}

function resumeSession() {
  paused = false;
  document.getElementById("pauseBtn").classList.remove("hidden");
  document.getElementById("resumeBtn").classList.add("hidden");
}

/* ---------------- FINISH ---------------- */
function finishSession() {
  bell();
  saveSession(true);
  document.getElementById("repeatBtn").classList.remove("hidden");
  document.getElementById("cancelBtn").classList.add("hidden");
}

function cancelSession() {
  saveSession(false);
  location.reload();
}

function repeatSession() {
  location.reload();
}

/* ---------------- HISTORY ---------------- */
function saveSession(completed) {
  const log = JSON.parse(localStorage.getItem("sessions") || "[]");
  log.unshift({
    date: new Date().toLocaleDateString(),
    completed,
    duration: boxes.reduce((a,b)=>a+b,0)
  });
  localStorage.setItem("sessions", JSON.stringify(log));
}

function toggleHistory() {
  const h = document.getElementById("history");
  h.classList.toggle("hidden");
  if (!h.classList.contains("hidden")) {
    renderHistory();
  }
}

function renderHistory() {
  const h = document.getElementById("history");
  const log = JSON.parse(localStorage.getItem("sessions") || "[]");
  h.innerHTML = "<h3>Sessions</h3>";
  log.forEach(s => {
    h.innerHTML += `${s.date} — ${s.duration} min — ${s.completed ? "✔" : "✖"}<br>`;
  });
}

/* ---------------- UTIL ---------------- */
function format(sec) {
  const m = Math.floor(sec/60);
  const s = sec % 60;
  return `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
}

function bell() {
  const ctx = new AudioContext();
  const o = ctx.createOscillator();
  o.frequency.value = 800;
  o.connect(ctx.destination);
  o.start();
  o.stop(ctx.currentTime + 0.2);
}

/* ---------------- EVENTS ---------------- */
startBtn.onclick = startSession;
pauseBtn.onclick = pauseSession;
resumeBtn.onclick = resumeSession;
cancelBtn.onclick = cancelSession;
repeatBtn.onclick = repeatSession;
addBoxBtn.onclick = () => {
  boxes.push(5);
  localStorage.setItem("boxes", JSON.stringify(boxes));
  renderBoxes();
  renderSessionInfo();
};
historyToggle.onclick = toggleHistory;
</script>

</body>
</html>
